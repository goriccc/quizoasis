<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MediaPipe ê°ì • ê°ì§€ í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .upload-area {
      border: 3px dashed #ccc;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      margin: 20px 0;
      cursor: pointer;
      transition: all 0.3s;
      user-select: none;
    }
    .upload-area:hover {
      border-color: #4CAF50;
      background: #f9f9f9;
    }
    .upload-area.dragover {
      border-color: #4CAF50;
      background: #e8f5e9;
    }
    #fileInput {
      display: none;
    }
    #preview {
      max-width: 100%;
      max-height: 500px;
      margin: 20px 0;
      border-radius: 10px;
      display: none;
    }
    .results {
      margin-top: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 10px;
    }
    .emotion-item {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .emotion-bar {
      height: 20px;
      background: #4CAF50;
      border-radius: 10px;
      transition: width 0.3s;
    }
    .blendshapes {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 12px;
    }
    .blendshape-item {
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .dominant {
      background: #ffeb3b !important;
      font-weight: bold;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    .error {
      color: red;
      padding: 10px;
      background: #ffebee;
      border-radius: 5px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” MediaPipe ê°ì • ê°ì§€ í…ŒìŠ¤íŠ¸</h1>
    <p>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ MediaPipeê°€ ê°ì§€í•œ ëª¨ë“  blendshapesì™€ ìµœì¢… ê°ì • ì ìˆ˜ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    
    <div class="upload-area" id="uploadArea">
      <p>ğŸ“¸ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
      <input type="file" id="fileInput" accept="image/*">
    </div>
    
    <img id="preview" alt="ë¯¸ë¦¬ë³´ê¸°">
    <div id="errorMessage"></div>
    
    <div class="loading" id="loading" style="display: none;">
      ë¶„ì„ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
    </div>
    
    <div class="results" id="results" style="display: none;">
      <h2>ğŸ“Š ê°ì • ë¶„ì„ ê²°ê³¼</h2>
      <div id="emotions"></div>
      
      <h3 style="margin-top: 30px;">ğŸ”¬ MediaPipe Blendshapes (ìƒìœ„ 50ê°œ)</h3>
      <div class="blendshapes" id="blendshapes"></div>
    </div>
  </div>

  <script type="module">
    let faceLandmarker = null;
    let initialized = false;

    // MediaPipe ì´ˆê¸°í™”
    async function initializeMediaPipe() {
      if (initialized) return faceLandmarker;
      
      try {
        console.log('MediaPipe ì´ˆê¸°í™” ì‹œì‘...');
        
        // ë™ì  import ì‚¬ìš© (React ì»´í¬ë„ŒíŠ¸ì™€ ë™ì¼í•œ ë°©ì‹)
        const vision = await import('https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/+esm');
        
        const filesetResolver = await vision.FilesetResolver.forVisionTasks(
          'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm'
        );
        
        faceLandmarker = await vision.FaceLandmarker.createFromOptions(filesetResolver, {
          baseOptions: {
            modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task',
            delegate: 'GPU'
          },
          outputFaceBlendshapes: true,
          runningMode: 'IMAGE',
          numFaces: 1
        });
        
        initialized = true;
        console.log('âœ… MediaPipe ì´ˆê¸°í™” ì™„ë£Œ');
        return faceLandmarker;
      } catch (error) {
        console.error('âŒ MediaPipe ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showError('MediaPipe ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        throw error;
      }
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.innerHTML = `<div class="error">${message}</div>`;
      setTimeout(() => {
        errorEl.innerHTML = '';
      }, 5000);
    }

    // ê°ì • ë¶„ì„ í•¨ìˆ˜ (HonestFacialEvaluationTestClientì™€ ë™ì¼í•œ ë¡œì§)
    function analyzeEmotionsFromBlendshapes(blendshapes) {
      const scores = {};
      let jawOpen = 0;
      let browDown = 0;
      let mouthFrown = 0;
      let mouthSmile = 0;
      
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ” ëª¨ë“  Blendshapes:', blendshapes.length, 'ê°œ');
      
      // Map MediaPipe blendshapes to emotions
      for (const blend of blendshapes) {
        const name = blend.categoryName.toLowerCase();
        
        // Happy indicators
        if (name.includes('smile') || name.includes('mouthsmile')) {
          const smileScore = blend.score;
          scores.happy = (scores.happy || 0) + smileScore;
          mouthSmile = Math.max(mouthSmile, smileScore);
          console.log(`ğŸ˜Š Happy (${name}): ${blend.score.toFixed(4)}`);
        }
        
        // Sad indicators
        if (name.includes('frown') || name.includes('mouthfrown')) {
          const frownScore = blend.score;
          scores.sad = (scores.sad || 0) + frownScore;
          mouthFrown = Math.max(mouthFrown, frownScore);
          console.log(`ğŸ˜¢ Sad (${name}): ${blend.score.toFixed(4)}`);
        }
        
        // Jaw open
        if (name.includes('jawopen')) {
          jawOpen = blend.score;
          if (blend.score > 0.3) {
            scores.surprised = (scores.surprised || 0) + blend.score * 0.7;
          }
          console.log(`ğŸ˜® JawOpen: ${blend.score.toFixed(4)}`);
        }
        
        // Mouth close/jaw clench - anger indicator
        if (name.includes('mouthclose') || name.includes('jawclench')) {
          scores.angry = (scores.angry || 0) + blend.score;
          console.log(`ğŸ˜  Angry (${name}): ${blend.score.toFixed(4)}`);
        }
        
        // Eyebrow up - surprised/fearful
        if (name.includes('browinnerup')) {
          scores.surprised = (scores.surprised || 0) + blend.score;
          scores.fearful = (scores.fearful || 0) + blend.score * 0.5;
          console.log(`ğŸ˜² Surprised/Fearful (${name}): ${blend.score.toFixed(4)}`);
        }
        
        // Eyebrow down - ANGRY indicator (strong signal)
        if (name.includes('browdownleft') || name.includes('browdownright')) {
          const browScore = blend.score;
          scores.angry = (scores.angry || 0) + browScore * 1.5;
          browDown = Math.max(browDown, browScore);
          console.log(`ğŸ˜¡ Angry - BrowDown (${name}): ${blend.score.toFixed(4)} â†’ ${(browScore * 1.5).toFixed(4)} (ê°€ì¤‘ì¹˜ 1.5ë°°)`);
        }
        
        // Nose sneer - disgust
        if (name.includes('nosesneerleft') || name.includes('nosesneerright')) {
          scores.disgusted = (scores.disgusted || 0) + blend.score;
          console.log(`ğŸ¤¢ Disgusted (${name}): ${blend.score.toFixed(4)}`);
        }
        
        // Mouth roll/lip suck - contempt
        if (name.includes('mouthroll') || name.includes('lipsuck')) {
          scores.contempt = (scores.contempt || 0) + blend.score;
          console.log(`ğŸ˜¤ Contempt (${name}): ${blend.score.toFixed(4)}`);
        }
      }
      
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“Š ì¡°í•© ê·œì¹™ ì ìš© ì „ ì ìˆ˜:', scores);
      console.log(`   jawOpen: ${jawOpen.toFixed(4)}, browDown: ${browDown.toFixed(4)}`);
      console.log(`   mouthFrown: ${mouthFrown.toFixed(4)}, mouthSmile: ${mouthSmile.toFixed(4)}`);
      
      // IMPORTANT: If jawOpen is high AND browDown is present, it's likely ANGRY
      if (jawOpen > 0.3 && browDown > 0.2) {
        console.log('ğŸ”¥ ì¡°í•© ê·œì¹™ ì ìš©: jawOpen + browDown â†’ angry ê°•í™”');
        scores.angry = (scores.angry || 0) + jawOpen * 1.2;
        scores.surprised = Math.max(0, (scores.surprised || 0) - jawOpen * 0.5);
        console.log(`   â†’ angry: ${scores.angry.toFixed(4)}, surprised ê°ì†Œ`);
      }
      
      // If mouthFrown is high with browDown, it's likely angry/sad mix
      if (mouthFrown > 0.3 && browDown > 0.2) {
        console.log('ğŸ”¥ ì¡°í•© ê·œì¹™ ì ìš©: mouthFrown + browDown â†’ angry ì¶”ê°€');
        scores.angry = (scores.angry || 0) + mouthFrown * 0.8;
        console.log(`   â†’ angry: ${scores.angry.toFixed(4)}`);
      }
      
      // If mouthSmile is very low and browDown is high, reduce happy score
      if (mouthSmile < 0.1 && browDown > 0.3) {
        console.log('ğŸ”¥ ì¡°í•© ê·œì¹™ ì ìš©: mouthSmile ë‚®ìŒ + browDown ë†’ìŒ â†’ happy ê°ì†Œ');
        scores.happy = Math.max(0, (scores.happy || 0) * 0.3);
        console.log(`   â†’ happy: ${scores.happy.toFixed(4)} (70% ê°ì†Œ)`);
      }
      
      // Calculate neutral
      const emotionSum = Object.values(scores).reduce((a, b) => a + b, 0);
      const neutralScore = Math.max(0, 1 - emotionSum / 2);
      
      // Normalize and return
      const emotions = {
        happy: Math.min(1, scores.happy || 0),
        sad: Math.min(1, scores.sad || 0),
        neutral: neutralScore,
        angry: Math.min(1, scores.angry || 0),
        surprised: Math.min(1, scores.surprised || 0),
        fearful: Math.min(1, scores.fearful || 0),
        disgusted: Math.min(1, scores.disgusted || 0),
        contempt: Math.min(1, scores.contempt || 0)
      };
      
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“Š ìµœì¢… ê°ì • ì ìˆ˜:', emotions);
      
      // Find dominant emotion
      const dominantEmotion = Object.entries(emotions).sort(([,a], [,b]) => b - a)[0];
      console.log(`ğŸ¯ Dominant Emotion: ${dominantEmotion[0]} (${dominantEmotion[1].toFixed(4)})`);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      return { emotions, dominantEmotion: dominantEmotion[0] };
    }

    // ì´ë¯¸ì§€ ë¶„ì„
    async function analyzeImage(imageFile) {
      const loadingEl = document.getElementById('loading');
      const resultsEl = document.getElementById('results');
      const previewEl = document.getElementById('preview');
      
      loadingEl.style.display = 'block';
      resultsEl.style.display = 'none';
      previewEl.style.display = 'none';

      try {
        // MediaPipe ì´ˆê¸°í™” í™•ì¸
        if (!faceLandmarker) {
          await initializeMediaPipe();
        }

        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = URL.createObjectURL(imageFile);
        
        await new Promise((resolve, reject) => {
          img.onload = resolve;
          img.onerror = () => reject(new Error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨'));
        });

        previewEl.src = img.src;
        previewEl.style.display = 'block';

        console.log('ì–¼êµ´ ë¶„ì„ ì‹œì‘...');
        const results = faceLandmarker.detect(img);
        const blendshapes = results.faceBlendshapes?.[0]?.categories || [];
        const landmarks = results.faceLandmarks?.[0];

        if (!blendshapes.length && !landmarks) {
          throw new Error('ì–¼êµ´ì„ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }

        console.log(`ê°ì§€ëœ Blendshapes: ${blendshapes.length}ê°œ`);
        console.log(`ê°ì§€ëœ Landmarks: ${landmarks ? landmarks.length : 0}ê°œ`);

        // ê°ì • ë¶„ì„
        const { emotions, dominantEmotion } = blendshapes.length > 0 
          ? analyzeEmotionsFromBlendshapes(blendshapes)
          : { emotions: { happy: 0, sad: 0, neutral: 0.7, angry: 0, surprised: 0, fearful: 0, disgusted: 0, contempt: 0 }, dominantEmotion: 'neutral' };

        // ê²°ê³¼ í‘œì‹œ
        displayResults(emotions, dominantEmotion, blendshapes);
        
        loadingEl.style.display = 'none';
        resultsEl.style.display = 'block';
        
        // ë©”ëª¨ë¦¬ ì •ë¦¬
        URL.revokeObjectURL(img.src);

      } catch (error) {
        console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
        showError('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        loadingEl.style.display = 'none';
      }
    }

    // ê²°ê³¼ í‘œì‹œ
    function displayResults(emotions, dominantEmotion, blendshapes) {
      const emotionsEl = document.getElementById('emotions');
      const blendshapesEl = document.getElementById('blendshapes');
      
      // ê°ì • ì ìˆ˜ í‘œì‹œ
      emotionsEl.innerHTML = '';
      const emotionNames = {
        happy: 'ğŸ˜Š í–‰ë³µ',
        sad: 'ğŸ˜¢ ìŠ¬í””',
        neutral: 'ğŸ˜ ì¤‘ë¦½',
        angry: 'ğŸ˜  í™”ë‚¨',
        surprised: 'ğŸ˜² ë†€ëŒ',
        fearful: 'ğŸ˜¨ ë‘ë ¤ì›€',
        disgusted: 'ğŸ¤¢ í˜ì˜¤',
        contempt: 'ğŸ˜¤ ê²½ë©¸'
      };

      Object.entries(emotions)
        .sort(([,a], [,b]) => b - a)
        .forEach(([emotion, score]) => {
          const item = document.createElement('div');
          item.className = 'emotion-item' + (emotion === dominantEmotion ? ' dominant' : '');
          item.innerHTML = `
            <span>${emotionNames[emotion]}: ${(score * 100).toFixed(2)}%</span>
            <div style="width: 300px;">
              <div class="emotion-bar" style="width: ${score * 100}%"></div>
            </div>
          `;
          emotionsEl.appendChild(item);
        });

      // ëª¨ë“  blendshapes í‘œì‹œ
      blendshapesEl.innerHTML = '';
      blendshapes
        .sort((a, b) => b.score - a.score)
        .slice(0, 50) // ìƒìœ„ 50ê°œë§Œ
        .forEach(blend => {
          const item = document.createElement('div');
          item.className = 'blendshape-item';
          item.innerHTML = `
            <strong>${blend.categoryName}</strong>: ${blend.score.toFixed(4)}
          `;
          blendshapesEl.appendChild(item);
        });
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');

    // í´ë¦­ ì´ë²¤íŠ¸
    uploadArea.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      fileInput.click();
    });
    
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        analyzeImage(file);
      } else {
        showError('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
      }
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.type.startsWith('image/')) {
          analyzeImage(file);
        } else {
          showError('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        }
      }
    });

    // ì´ˆê¸°í™”
    console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ. MediaPipe ì´ˆê¸°í™” ì¤‘...');
    initializeMediaPipe().catch(err => {
      console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
    });
  </script>
</body>
</html>
